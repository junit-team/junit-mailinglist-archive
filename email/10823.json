{
    "numMessagesInTopic": 2, 
    "nextInTime": 10824, 
    "senderId": "CdmJvZcCA6fu2UZuM388dHgQfrlAV2hZkaY-XsEJsCqTg_cC2Q3iuvdAPhhs7GfSQJtT8RH3mqeb9r6AqbsLIcXjdXb7y0uqu8R6", 
    "systemMessage": false, 
    "subject": "Re: [junit] confused about database dependent tests", 
    "from": "Curt Sampson &lt;yahoo_sucks@...&gt;", 
    "authorName": "Curt Sampson", 
    "msgSnippet": "... You definitely need a test db; preferably one for each developer that can easily be reloaded to a default configuration. At my shop, every developer has", 
    "msgId": 10823, 
    "profile": "cjstokyo", 
    "topicId": 10816, 
    "spamInfo": {
        "reason": "0", 
        "isSpam": false
    }, 
    "replyTo": "LIST", 
    "userId": 110189933, 
    "messageBody": "<div id=\"ygrps-yiv-838901816\">On Thu, 8 Apr 2004, mbil_99 wrote:<br/>\n<br/>\n<blockquote><span title=\"ireply\"> &gt; So what do I do here, create a fake Customer in the production db?<br/>\n&gt; (Ideally have a test db where this isn&#39;t a problem?)<br/>\n<br/>\n </span></blockquote>You definitely need a test db; preferably one for each developer that<br/>\ncan easily be reloaded to a &quot;default&quot; configuration. At my shop, every<br/>\ndeveloper has at least one database all to himself, and we have a script<br/>\ncalled &quot;LoadUnitTestDB&quot; which loads up schemas for all of our various<br/>\ndifferent databases (wiping out existing ones) and their test data. The<br/>\nunit tests that use databases run against these.<br/>\n<br/>\nI have a single class responsible for each table (or sometimes group of<br/>\ntables, if they&#39;re closely related) that does the grunt work of writing<br/>\nstuff to the tables, and reading them and creating objects. Say:<br/>\n<br/>\n    public class Gift {<br/>\n\tstatic void createGift(Connection con, int customerID, int giftTypeID);<br/>\n\tstatic Gift getGift(Connection con, int customerID);<br/>\n\t// Then the non-static methods for the gift object itself.<br/>\n    }<br/>\n<br/>\nThe unit tests for the above two static methods supply a connection to<br/>\nthe test database, and later check the database to see that the right<br/>\nthing was done. As a little bonus, all of the database unit tests start<br/>\na transaction before running the test and roll it back after they&#39;ve<br/>\nfinished checking the database, so the test databases are actually never<br/>\nchanged.<br/>\n<br/>\nIn the production system, I have a Repository responsible for dealing<br/>\nwith the connections and suchlike, and the business logic asks the<br/>\nrepository for the objects that it needs, and to do the database updates<br/>\nthat it ought to do. In the unit tests, the repository is replaced with<br/>\na mock object that pretends to do the database work.<br/>\n<br/>\nSo, here&#39;s the requirement.<br/>\n<br/>\n<blockquote><span title=\"ireply\"> &gt; If &quot;Customer&quot;&#39;s last &quot;Order&quot; was greater than $100,<br/>\n&gt;     then record the fact that they are eligible to receive a gift<br/>\n&gt;     with their next order.<br/>\n<br/>\n </span></blockquote>Now I&#39;ve been thinking about this for about five minutes now, and<br/>\nI&#39;m having some problems with this. I think I just realized what<br/>\nit is: you&#39;ve already recorded this information! First, from this<br/>\nspecification, there&#39;s no need to store in the database that the<br/>\ncustomer is elegible for a gift; just look at the last order (presumably<br/>\nalso stored in the database) and you&#39;ll know. (Or I&#39;m missing some<br/>\nother information here.) Second there&#39;s no indication here of whose<br/>\nresponsibility this action is. A Customer? A Gift?<br/>\n<br/>\nSo let&#39;s change this to something more tractable for me; let&#39;s say it&#39;s<br/>\nan Order&#39;s responibility, on creation, for making sure that it knows<br/>\nthat the customer is eligible for a gift. In other words:<br/>\n<br/>\n    When a new order is created for a customer whose total for the<br/>\n    previous order was greater than $100, ask a gift manager for<br/>\n    a gift.<br/>\n<br/>\nSo let&#39;s try it:<br/>\n<br/>\n    class TestNewOrderIncludingGift_Customer extends Customer {<br/>\n\tpublic int getID() {<br/>\n\t    return 171431;<br/>\n\t}<br/>\n\tpublic Order getLastOrder() {<br/>\n\t    return new Order() {<br/>\n\t\tpublic DollarAmount getTotalAmount() {<br/>\n\t\t    return new DollarAmount(135, 23);\t// $135.23<br/>\n\t\t}<br/>\n\t    }<br/>\n\t}<br/>\n    }<br/>\n<br/>\n    class TestNewOrderIncludingGift_GiftManager extends GiftManager {<br/>\n\tpublic getGift(Customer customer) {<br/>\n\t    // Did it pass in the correct customer?<br/>\n\t    assertEquals(171431, customer.getID());<br/>\n\t    return new Gift(&quot;foobar&quot;);<br/>\n\t}<br/>\n    }<br/>\n<br/>\n    class TestNewOrderIncludingGift_Repository extends TestRepository {<br/>\n\tpublic GiftManager getGiftManager() {<br/>\n\t    return new TestNewOrderIncludingGift_GiftManager();<br/>\n\t}<br/>\n    }<br/>\n<br/>\n    public void testNewOrderIncludingGift() {<br/>\n\tEnvironment.setRepository(new TestNewOrderIncludingGift_Repository());<br/>\n\tOrder order<br/>\n\t    = Order.createOrder(new TestNewOrderIncludingGift_Customer());<br/>\n\tassertEquals(&quot;foobar&quot;, order.getGift().getType());<br/>\n    }<br/>\n<br/>\nJust in case the intended implemenation is not obvious:<br/>\n<br/>\n    class Order {<br/>\n\tprivate final Gift _gift;<br/>\n<br/>\n\tpublic static createOrder(Customer customer) {<br/>\n\t    DollarAmount last = customer.getLastOrder.getTotalAmount();<br/>\n\t    if (last.lessThanOrEqual(new DollarAmount(100, 00))) {<br/>\n\t\t_gift = null;<br/>\n\t    } else {<br/>\n\t\tGiftManager giftManager<br/>\n\t\t    = Environment.getRepository().getGiftManager();<br/>\n\t\t_gift = giftManager.getGift(customer);<br/>\n\t    }<br/>\n\t}<br/>\n<br/>\n\tpublic Gift getGift() {<br/>\n\t    return _gift;<br/>\n\t}<br/>\n    }<br/>\n<br/>\n(Though I&#39;m already thinking that it&#39;s probably the GiftManager&#39;s job to<br/>\nbe doing the calculation about whether a customer&#39;s last order warranted<br/>\na gift, rather than the new Order doing this.)<br/>\n<br/>\nBut anyway, you&#39;ve now made sure that the order made the appropriate<br/>\ncalls on the database objects without ever touching a database.<br/>\n<br/>\ncjs<br/>\n-- <br/>\nCurt Sampson  &lt;<a rel=\"nofollow\" target=\"_blank\" href=\"mailto:cjs@...\">cjs@...</a>&gt;   +81 90 7737 2974   <a rel=\"nofollow\" target=\"_blank\" href=\"http://www.NetBSD.org\">http://www.NetBSD.org</a><br/>\n    Don&#39;t you know, in this new Dark Age, we&#39;re all light.  --XTC</div>", 
    "prevInTime": 10822, 
    "specialLinks": [], 
    "contentTrasformed": false, 
    "postDate": "1081675198", 
    "canDelete": false, 
    "nextInTopic": 0, 
    "prevInTopic": 10816, 
    "headers": {
        "inReplyToHeader": "PGM1NGdmaSszbHZwQGVHcm91cHMuY29tPg==", 
        "messageIdInHeader": "PFBpbmUuTkVCLjQuNTguMDQwNDExMTc0NDEwMC4xNDI4OUBhbmdlbGljLXZ0ZncuY3Zwbi5jeW5pYy5uZXQ+", 
        "referencesHeader": "PGM1NGdmaSszbHZwQGVHcm91cHMuY29tPg=="
    }
}