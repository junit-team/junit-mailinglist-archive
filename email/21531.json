{
    "numMessagesInTopic": 9, 
    "nextInTime": 21532, 
    "senderId": "NN9ke6ZS5oKQEGOJD20cfgfObCq_jBf5IN1AHENbBKfuJUUdUAp0xqkVY8II5SNvGu4aVgu6nE62ev3UL3WVFApKL8M", 
    "systemMessage": false, 
    "subject": "RE: [junit] Race condition with timeouts", 
    "from": "&quot;kentb&quot; &lt;kentb@...&gt;", 
    "authorName": "kentb", 
    "msgSnippet": "All, Thanks for the help with the race condition. Saff fixed it by using plain old threads instead of this fancy new-fangled Future stuff. Happy testing (just", 
    "msgId": 21531, 
    "profile": "kentlbeck", 
    "topicId": 21487, 
    "spamInfo": {
        "reason": "12", 
        "isSpam": false
    }, 
    "replyTo": "LIST", 
    "userId": 173198504, 
    "messageBody": "<div id=\"ygrps-yiv-844486315\">All,<br/>\n <br/>\nThanks for the help with the race condition. Saff fixed it by using plain<br/>\nold threads instead of this fancy new-fangled Future stuff.<br/>\n <br/>\nHappy testing (just not too long)!<br/>\n <br/>\nKent<br/>\n<br/>\n  _____  <br/>\n<br/>\nFrom: <a rel=\"nofollow\" target=\"_blank\" href=\"mailto:junit@yahoogroups.com\">junit@yahoogroups.com</a> [mailto:<a rel=\"nofollow\" target=\"_blank\" href=\"mailto:junit@yahoogroups.com\">junit@yahoogroups.com</a>] On Behalf Of<br/>\nGilles Scokart<br/>\nSent: Friday, April 10, 2009 6:58 AM<br/>\nTo: <a rel=\"nofollow\" target=\"_blank\" href=\"mailto:junit@yahoogroups.com\">junit@yahoogroups.com</a><br/>\nSubject: Re: [junit] Race condition with timeouts<br/>\n<br/>\n<br/>\n<br/>\n<br/>\n<br/>\nWhy do you need this first :<br/>\n<br/>\nservice.awaitTermination(fTimeout, TimeUnit.MILLISECONDS);<br/>\n<br/>\nMaybe just :<br/>\n<br/>\nresult.get(0, TimeUnit.MILLISECONDS);<br/>\n<br/>\nwith a shutdownNow after in a finally block if required.<br/>\n<br/>\nI would expect you always get InterrpuptedException because you are sending<br/>\nit to the service thread via shutdownNow. Once you get the result from your<br/>\nFuture, you should get it.<br/>\nHowever, I guess that because your timeout is very small, the get method<br/>\nmight times out before the service thread is reactivated. So in those case,<br/>\nyou get only your TimeOut and throw your exception.<br/>\n<br/>\nGilles Scokart<br/>\n<br/>\n2009/4/10 Ilja Preu√ü &lt;iljapreuss@googlema<br/>\n&lt;mailto:iljapreuss%40googlemail.com&gt; il.com&gt;<br/>\n<br/>\n<blockquote><span title=\"ireply\"> &gt;<br/>\n&gt;<br/>\n&gt; I&#39;m assuming that the InterruptedException is caused by<br/>\n&gt; service.shutdownNow(), which, according to javadoc, &quot;typical<br/>\n&gt; implementations will cancel via Thread.interrupt()&quot;.<br/>\n&gt;<br/>\n&gt; What is causing the TimeoutException? Unfortunately, your code throws<br/>\n&gt; away the original stacktrace, and I don&#39;t know the executor API well<br/>\n&gt; enough to guess...<br/>\n&gt;<br/>\n&gt; Cheers, Ilja<br/>\n&gt;<br/>\n&gt; 2009/4/9 kentb &lt;kentb@earthlink. &lt;mailto:kentb%40earthlink.net&gt; net<br/>\n </span></blockquote>&lt;kentb%40earthlink.net&gt;&gt;:<br/>\n<blockquote><span title=\"ireply\"> &gt;<br/>\n&gt; &gt;<br/>\n&gt; &gt;<br/>\n&gt; &gt; All,<br/>\n&gt; &gt;<br/>\n&gt; &gt; This is a test of the &quot;with enough eyeballs, all bugs are shallow&quot;<br/>\n&gt; &gt; hypothesis.<br/>\n&gt; &gt;<br/>\n&gt; &gt; I am experiencing a race condition with timeouts. Say I have a test like<br/>\n&gt; &gt; this:<br/>\n&gt; &gt;<br/>\n&gt; &gt; public class WaitTooLong {<br/>\n&gt; &gt; @Test(timeout=10) public void ripVanWinkle() throws<br/>\n&gt; &gt; InterruptedException {<br/>\n&gt; &gt; Thread.sleep(100);<br/>\n&gt; &gt; }<br/>\n&gt; &gt; }<br/>\n&gt; &gt;<br/>\n&gt; &gt; When I run this I get one of two errors, non-deterministically:<br/>\n&gt; &gt;<br/>\n&gt; &gt; java.lang.InterruptedException: sleep interrupted<br/>\n&gt; &gt; at java.lang.Thread.sleep(Native Method)<br/>\n&gt; &gt; at UnpredictableTest.takeTen(UnpredictableTest.java:5)<br/>\n&gt; &gt; ...<br/>\n&gt; &gt;<br/>\n&gt; &gt; or<br/>\n&gt; &gt;<br/>\n&gt; &gt; java.lang.Exception: test timed out after 10 milliseconds<br/>\n&gt; &gt; at<br/>\n&gt; &gt;<br/>\n&gt;<br/>\n </span></blockquote>org.junit.internal.runners.statements.FailOnTimeout.evaluate(FailOnTimeout.j<br/>\n<blockquote><span title=\"ireply\"> &gt; &gt; ava:48)<br/>\n&gt; &gt; ...<br/>\n&gt; &gt;<br/>\n&gt; &gt; Here&#39;s the relevant code in JUnit (FailOnTimeout):<br/>\n&gt; &gt;<br/>\n&gt; &gt; public void evaluate() throws Throwable {<br/>\n&gt; &gt; ExecutorService service=<br/>\n&gt; &gt; Executors.newSingleThreadExecutor();<br/>\n&gt; &gt; Callable&lt;Object&gt; callable= new Callable&lt;Object&gt;() {<br/>\n&gt; &gt; public Object call() throws Exception {<br/>\n&gt; &gt; try {<br/>\n&gt; &gt; fNext.evaluate();<br/>\n&gt; &gt; } catch (Throwable e) {<br/>\n&gt; &gt; throw new ExecutionException(e);<br/>\n&gt; &gt; }<br/>\n&gt; &gt; return null;<br/>\n&gt; &gt; }<br/>\n&gt; &gt; };<br/>\n&gt; &gt; Future&lt;Object&gt; result= service.submit(callable);<br/>\n&gt; &gt; service.shutdown();<br/>\n&gt; &gt; try {<br/>\n&gt; &gt; boolean terminated=<br/>\n&gt; &gt; service.awaitTermination(fTimeout, TimeUnit.MILLISECONDS);<br/>\n&gt; &gt; if (!terminated)<br/>\n&gt; &gt; service.shutdownNow();<br/>\n&gt; &gt; result.get(0, TimeUnit.MILLISECONDS); // throws the<br/>\n&gt; &gt; exception if one occurred during the invocation<br/>\n&gt; &gt; } catch (TimeoutException e) {<br/>\n&gt; &gt; throw new Exception(String.format(&quot;test timed out<br/>\n&gt; &gt; after %d milliseconds&quot;, fTimeout));<br/>\n&gt; &gt; } catch (ExecutionException e) {<br/>\n&gt; &gt; throw unwrap(e);<br/>\n&gt; &gt; }<br/>\n&gt; &gt; }<br/>\n&gt; &gt;<br/>\n&gt; &gt; It seems that sometimes the TimeoutException gets thrown and caught and<br/>\n&gt; the<br/>\n&gt; &gt; Exception thrown. Sometimes, though, the InterruptedException that is<br/>\n&gt; &gt; terminating the test-running thread gets thrown/caught first. I&#39;ve<br/>\n </span></blockquote>stared<br/>\n<blockquote><span title=\"ireply\"> &gt; at<br/>\n&gt; &gt; this enough minutes to be ready for help.<br/>\n&gt; &gt;<br/>\n&gt; &gt; One strangeness is that if I run the test programmatically<br/>\n&gt; &gt; (&quot;JUnitCore.runClass(WaitTooLong.class)&quot;) the Exception is always<br/>\n </span></blockquote>thrown.<br/>\n<blockquote><span title=\"ireply\"> &gt; If<br/>\n&gt; &gt; I run the test with the Eclipse JUnit runner or with JUnit Max, the<br/>\n&gt; results<br/>\n&gt; &gt; are non-deterministic.<br/>\n&gt; &gt;<br/>\n&gt; &gt; Any ideas for making this deterministic? I would prefer the second<br/>\n </span></blockquote>result<br/>\n<blockquote><span title=\"ireply\"> &gt; &gt; above, if I can get it.<br/>\n&gt; &gt;<br/>\n&gt; &gt; Regards,<br/>\n&gt; &gt;<br/>\n&gt; &gt; Kent Beck<br/>\n&gt; &gt; Three Rivers Institute<br/>\n&gt; &gt;<br/>\n&gt; &gt;<br/>\n&gt; <br/>\n&gt;<br/>\n<br/>\n </span></blockquote>[Non-text portions of this message have been removed]<br/>\n<br/>\n<br/>\n<br/>\n<br/>\n<br/>\n<br/>\n[Non-text portions of this message have been removed]</div>", 
    "prevInTime": 21530, 
    "specialLinks": [], 
    "contentTrasformed": false, 
    "postDate": "1240594824", 
    "canDelete": false, 
    "nextInTopic": 0, 
    "prevInTopic": 21494, 
    "headers": {
        "inReplyToHeader": "PGU5ZDhhMjYxMDkwNDEwMDY1OG4xODE4ZmNhYXllNDZiMzExOTQ5MDRlOWIxQG1haWwuZ21haWwuY29tPg==", 
        "messageIdInHeader": "PDg0NzZEODJBNjA5NTRFN0Y5MUI1REIxRUY4OEZFRUYzQGtlbnRzcGF2aWxpb24+", 
        "referencesHeader": "PENGQjU3RjExN0NFOTRCMDE5NkNEOEJGNjVCOEY3MERFQGtlbnRzcGF2aWxpb24+IDxmYmEyOTY5NzA5MDQxMDAyMzZ4NjVkYzMxM3hkYmJiZWY0M2MyY2ZhYWU1QG1haWwuZ21haWwuY29tPiA8ZTlkOGEyNjEwOTA0MTAwNjU4bjE4MThmY2FheWU0NmIzMTE5NDkwNGU5YjFAbWFpbC5nbWFpbC5jb20+"
    }
}