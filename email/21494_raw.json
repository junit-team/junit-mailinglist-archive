{
    "numMessagesInTopic": 9, 
    "nextInTime": 21495, 
    "senderId": "EB5gePl2s_xLp8ivWoG7JamiotusXaURg7nKfdQ3SfmpSLYElirbbAl-sbHvliUmENtq738iLKkb_pD3oX4zuA07MZbG4qKJYZY", 
    "systemMessage": true, 
    "subject": "Re: [junit] Race condition with timeouts", 
    "from": "Gilles Scokart &lt;gscokart@...&gt;", 
    "authorName": "Gilles Scokart", 
    "msgSnippet": "Why do you need this first : service.awaitTermination(fTimeout, TimeUnit.MILLISECONDS); Maybe just : result.get(0, TimeUnit.MILLISECONDS); with a shutdownNow", 
    "msgId": 21494, 
    "rawEmail": "Return-Path: &lt;gscokart@...&gt;\r\nReceived: (qmail 78872 invoked from network); 11 Apr 2009 16:45:42 -0000\r\nReceived: from unknown (69.147.108.201)\n  by m3.grp.re1.yahoo.com with QMQP; 11 Apr 2009 16:45:42 -0000\r\nReceived: from unknown (HELO n41b.bullet.mail.sp1.yahoo.com) (66.163.168.155)\n  by mta2.grp.re1.yahoo.com with SMTP; 11 Apr 2009 16:45:40 -0000\r\nDKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed; d=yahoogroups.com; s=lima; t=1239468316; bh=43YBjCwBbvHTLZ4nn2gg3cbjtAX5aK/Ndb1uc0UAwCk=; h=Received:Received:X-Sender:X-Apparently-To:X-Received:X-Received:X-Received:X-Received:MIME-Version:X-Received:In-Reply-To:References:Date:Message-ID:To:X-Originating-IP:X-eGroups-Msg-Info:From:Subject:X-Yahoo-Group-Post:X-Yahoo-Profile:Content-Type:Content-Transfer-Encoding:Sender:X-Yahoo-Newman-Property:X-eGroups-Approved-By:X-eGroups-Auth; b=hOCAwk+kEpxI6MOjoNeqXUfLANQc6013B6jiXA0WrGTN/EmQS0zsPyTV08NoPGodMvffvFoWhFYG7vMT9pPSODlmbaSkSG4IIF/OeGghKim833odEzn1/wbCYQJ9rLsi\r\nReceived: from [69.147.65.148] by n41.bullet.mail.sp1.yahoo.com with NNFMP; 11 Apr 2009 16:45:16 -0000\r\nReceived: from [98.137.34.36] by t11.bullet.mail.sp1.yahoo.com with NNFMP; 11 Apr 2009 16:45:16 -0000\r\nX-Sender: gscokart@...\r\nX-Apparently-To: junit@yahoogroups.com\r\nX-Received: (qmail 26314 invoked from network); 10 Apr 2009 13:59:29 -0000\r\nX-Received: from unknown (69.147.108.201)\n  by m7.grp.re1.yahoo.com with QMQP; 10 Apr 2009 13:59:29 -0000\r\nX-Received: from unknown (HELO mail-fx0-f171.google.com) (209.85.220.171)\n  by mta2.grp.re1.yahoo.com with SMTP; 10 Apr 2009 13:59:28 -0000\r\nX-Received: by fxm19 with SMTP id 19so1140128fxm.26\n        for &lt;junit@yahoogroups.com&gt;; Fri, 10 Apr 2009 06:58:28 -0700 (PDT)\r\nMIME-Version: 1.0\r\nX-Received: by 10.223.105.195 with SMTP id u3mr1094642fao.13.1239371908198; Fri, \n\t10 Apr 2009 06:58:28 -0700 (PDT)\r\nIn-Reply-To: &lt;fba296970904100236x65dc313xdbbbef43c2cfaae5@...&gt;\r\nReferences: &lt;CFB57F117CE94B0196CD8BF65B8F70DE@kentspavilion&gt;\n\t &lt;fba296970904100236x65dc313xdbbbef43c2cfaae5@...&gt;\r\nDate: Fri, 10 Apr 2009 15:58:28 +0200\r\nMessage-ID: &lt;e9d8a2610904100658n1818fcaaye46b31194904e9b1@...&gt;\r\nTo: junit@yahoogroups.com\r\nX-eGroups-Msg-Info: 1:12:0:0:0\r\nFrom: Gilles Scokart &lt;gscokart@...&gt;\r\nSubject: Re: [junit] Race condition with timeouts\r\nX-Yahoo-Group-Post: member; u=298263068; y=k0NZXo-ttPLcdh4h2A2wNTM_Mhwld5CP5SIOgoi1dmQvhEI\r\nX-Yahoo-Profile: gscokart\r\nContent-Type: text/plain; charset=ISO-8859-1\r\nContent-Transfer-Encoding: quoted-printable\r\nX-Yahoo-Newman-Property: groups-system\r\nX-eGroups-Approved-By: spchappell &lt;simonpeterchappell@...&gt; via web; 11 Apr 2009 16:45:15 -0000\r\n\r\nWhy do you need this first :\n\nservice.awaitTermination(fTimeout, TimeUnit.M=\r\nILLISECONDS);\n\nMaybe just :\n\nresult.get(0, TimeUnit.MILLISECONDS);\n\nwith a =\r\nshutdownNow after in a finally block if required.\n\nI would expect you alway=\r\ns get InterrpuptedException because you are sending\nit to the service threa=\r\nd via shutdownNow.  Once you get the result from your\nFuture, you should ge=\r\nt it.\nHowever, I guess that because your timeout is very small, the get met=\r\nhod\nmight times out before the service thread is reactivated.  So in those =\r\ncase,\nyou get only your TimeOut and throw your exception.\n\nGilles Scokart\n\n=\r\n\n2009/4/10 Ilja Preu=DF &lt;iljapreuss@...&gt;\n\n&gt;\n&gt;\n&gt; I&#39;m assuming tha=\r\nt the InterruptedException is caused by\n&gt; service.shutdownNow(), which, acc=\r\nording to javadoc, &quot;typical\n&gt; implementations will cancel via Thread.interr=\r\nupt()&quot;.\n&gt;\n&gt; What is causing the TimeoutException? Unfortunately, your code =\r\nthrows\n&gt; away the original stacktrace, and I don&#39;t know the executor API we=\r\nll\n&gt; enough to guess...\n&gt;\n&gt; Cheers, Ilja\n&gt;\n&gt; 2009/4/9 kentb &lt;kentb@earthlin=\r\nk.net &lt;kentb%40earthlink.net&gt;&gt;:\n&gt;\n&gt; &gt;\n&gt; &gt;\n&gt; &gt; All,\n&gt; &gt;\n&gt; &gt; This is a test o=\r\nf the &quot;with enough eyeballs, all bugs are shallow&quot;\n&gt; &gt; hypothesis.\n&gt; &gt;\n&gt; &gt; =\r\nI am experiencing a race condition with timeouts. Say I have a test like\n&gt; =\r\n&gt; this:\n&gt; &gt;\n&gt; &gt; public class WaitTooLong {\n&gt; &gt; @Test(timeout=3D10) public v=\r\noid ripVanWinkle() throws\n&gt; &gt; InterruptedException {\n&gt; &gt; Thread.sleep(100);=\r\n\n&gt; &gt; }\n&gt; &gt; }\n&gt; &gt;\n&gt; &gt; When I run this I get one of two errors, non-determini=\r\nstically:\n&gt; &gt;\n&gt; &gt; java.lang.InterruptedException: sleep interrupted\n&gt; &gt; at =\r\njava.lang.Thread.sleep(Native Method)\n&gt; &gt; at UnpredictableTest.takeTen(Unpr=\r\nedictableTest.java:5)\n&gt; &gt; ...\n&gt; &gt;\n&gt; &gt; or\n&gt; &gt;\n&gt; &gt; java.lang.Exception: test =\r\ntimed out after 10 milliseconds\n&gt; &gt; at\n&gt; &gt;\n&gt; org.junit.internal.runners.sta=\r\ntements.FailOnTimeout.evaluate(FailOnTimeout.j\n&gt; &gt; ava:48)\n&gt; &gt; ...\n&gt; &gt;\n&gt; &gt; =\r\nHere&#39;s the relevant code in JUnit (FailOnTimeout):\n&gt; &gt;\n&gt; &gt; public void eval=\r\nuate() throws Throwable {\n&gt; &gt; ExecutorService service=3D\n&gt; &gt; Executors.newS=\r\ningleThreadExecutor();\n&gt; &gt; Callable&lt;Object&gt; callable=3D new Callable&lt;Object=\r\n&gt;() {\n&gt; &gt; public Object call() throws Exception {\n&gt; &gt; try {\n&gt; &gt; fNext.evalu=\r\nate();\n&gt; &gt; } catch (Throwable e) {\n&gt; &gt; throw new ExecutionException(e);\n&gt; &gt;=\r\n }\n&gt; &gt; return null;\n&gt; &gt; }\n&gt; &gt; };\n&gt; &gt; Future&lt;Object&gt; result=3D service.submi=\r\nt(callable);\n&gt; &gt; service.shutdown();\n&gt; &gt; try {\n&gt; &gt; boolean terminated=3D\n&gt; =\r\n&gt; service.awaitTermination(fTimeout, TimeUnit.MILLISECONDS);\n&gt; &gt; if (!termi=\r\nnated)\n&gt; &gt; service.shutdownNow();\n&gt; &gt; result.get(0, TimeUnit.MILLISECONDS);=\r\n // throws the\n&gt; &gt; exception if one occurred during the invocation\n&gt; &gt; } ca=\r\ntch (TimeoutException e) {\n&gt; &gt; throw new Exception(String.format(&quot;test time=\r\nd out\n&gt; &gt; after %d milliseconds&quot;, fTimeout));\n&gt; &gt; } catch (ExecutionExcepti=\r\non e) {\n&gt; &gt; throw unwrap(e);\n&gt; &gt; }\n&gt; &gt; }\n&gt; &gt;\n&gt; &gt; It seems that sometimes th=\r\ne TimeoutException gets thrown and caught and\n&gt; the\n&gt; &gt; Exception thrown. S=\r\nometimes, though, the InterruptedException that is\n&gt; &gt; terminating the test=\r\n-running thread gets thrown/caught first. I&#39;ve stared\n&gt; at\n&gt; &gt; this enough =\r\nminutes to be ready for help.\n&gt; &gt;\n&gt; &gt; One strangeness is that if I run the =\r\ntest programmatically\n&gt; &gt; (&quot;JUnitCore.runClass(WaitTooLong.class)&quot;) the Exc=\r\neption is always thrown.\n&gt; If\n&gt; &gt; I run the test with the Eclipse JUnit run=\r\nner or with JUnit Max, the\n&gt; results\n&gt; &gt; are non-deterministic.\n&gt; &gt;\n&gt; &gt; Any=\r\n ideas for making this deterministic? I would prefer the second result\n&gt; &gt; =\r\nabove, if I can get it.\n&gt; &gt;\n&gt; &gt; Regards,\n&gt; &gt;\n&gt; &gt; Kent Beck\n&gt; &gt; Three Rivers=\r\n Institute\n&gt; &gt;\n&gt; &gt;\n&gt;  \n&gt;\n\n\n[Non-text portions of this message have been rem=\r\noved]\n\n\n", 
    "profile": "gscokart", 
    "topicId": 21487, 
    "spamInfo": {
        "reason": "12", 
        "isSpam": false
    }, 
    "replyTo": "LIST", 
    "userId": 298263068, 
    "prevInTime": 21493, 
    "contentTrasformed": false, 
    "postDate": "1239371908", 
    "canDelete": false, 
    "nextInTopic": 21531, 
    "prevInTopic": 21493, 
    "headers": {
        "inReplyToHeader": "PGZiYTI5Njk3MDkwNDEwMDIzNng2NWRjMzEzeGRiYmJlZjQzYzJjZmFhZTVAbWFpbC5nbWFpbC5jb20+", 
        "messageIdInHeader": "PGU5ZDhhMjYxMDkwNDEwMDY1OG4xODE4ZmNhYXllNDZiMzExOTQ5MDRlOWIxQG1haWwuZ21haWwuY29tPg==", 
        "referencesHeader": "PENGQjU3RjExN0NFOTRCMDE5NkNEOEJGNjVCOEY3MERFQGtlbnRzcGF2aWxpb24+CSA8ZmJhMjk2OTcwOTA0MTAwMjM2eDY1ZGMzMTN4ZGJiYmVmNDNjMmNmYWFlNUBtYWlsLmdtYWlsLmNvbT4="
    }
}