{
    "numMessagesInTopic": 6, 
    "nextInTime": 24392, 
    "senderId": "gXLHyEhKA1Mx4w3Mkz0zVbcC3QUrF3vCaWOzHbY43caukhAW1Lc1EAmMTZajdSfKKLObCxgEGXEyDlc8c5i8TjDLwceFowZF", 
    "systemMessage": true, 
    "subject": "Re: [junit] Timed Tests and Thread Safety", 
    "from": "Kevin Cooney &lt;kcooney@...&gt;", 
    "authorName": "Kevin Cooney", 
    "msgSnippet": "Note the Timeout rule will call @Before and @After methods in the same thread as the test. The test class is created before rules are applied, so if your test", 
    "msgId": 24391, 
    "profile": "kevincooney2000", 
    "topicId": 24388, 
    "spamInfo": {
        "reason": "12", 
        "isSpam": false
    }, 
    "replyTo": "LIST", 
    "userId": 475263748, 
    "messageBody": "<div id=\"ygrps-yiv-1349299940\">Note the Timeout rule will call @Before and @After methods in the same<br/>\nthread as the test. The test class is created before rules are applied, so<br/>\nif your test class initializes fields at declaration time, that execution<br/>\nwould happen in a different thread than the test.<br/>\n<br/>\nI also believe that @After methods would not be called for tests methods<br/>\nthat timeout in classes that use the Timeout rule.<br/>\n<br/>\n- Kevin<br/>\n<blockquote><span title=\"qreply\"> On May 24, 2013 8:25 AM, &quot;David Saff&quot; &lt;<a rel=\"nofollow\" target=\"_blank\" href=\"mailto:saff@...\">saff@...</a>&gt; wrote:<br/>\n<br/>\n&gt; Steve,<br/>\n&gt;<br/>\n&gt; You raise a great question.  Unfortunately, and perhaps I&#39;m missing<br/>\n&gt; something obvious, I don&#39;t think there&#39;s a way to provide timeout<br/>\n&gt; semantics, guarantee that @After is called, and guarantee that @After is<br/>\n&gt; called on the same thread as the @Test method.  Essentially, once the<br/>\n&gt; runner hands over control to the @Test thread, there&#39;s no guarantee that it<br/>\n&gt; will ever return control back--it could go into an infinite loop that<br/>\n&gt; catches InterruptedExceptions.<br/>\n&gt;<br/>\n&gt; It would potentially be possible to guarantee that successful tests that<br/>\n&gt; complete within the timeout have @After methods called on the same thread,<br/>\n&gt; but that would further complicate matters, with questionable (IMHO) payoff.<br/>\n&gt;<br/>\n&gt; The biggest payoff would probably be to make sure that the documentation we<br/>\n&gt; have makes it easy to avoid any unexpected behavior.  Can you suggest an<br/>\n&gt; edit to that effect?  Thanks,<br/>\n&gt;<br/>\n&gt;    David Saff<br/>\n&gt;<br/>\n&gt;<br/>\n&gt; On Thu, May 23, 2013 at 8:34 PM, Steven Soloff &lt;<a rel=\"nofollow\" target=\"_blank\" href=\"mailto:s_soloff@...\">s_soloff@...</a><br/>\n&gt; &gt;wrote:<br/>\n&gt;<br/>\n&gt; &gt; **<br/>\n&gt; &gt;<br/>\n&gt; &gt;<br/>\n&gt; &gt; Hi All,<br/>\n&gt; &gt;<br/>\n&gt; &gt; I&#39;ve been using timed tests (i.e. @Test(timeout = ...)) for years but<br/>\n&gt; &gt; recently came across an implementation detail of which I was unaware.<br/>\n&gt; While<br/>\n&gt; &gt; I knew that timed tests are run in a thread other than the main test<br/>\n&gt; &gt; thread, I assumed that all aspects of the test (set up, test, and tear<br/>\n&gt; &gt; down) were run in that other thread. I was surprised to discover that the<br/>\n&gt; &gt; set up and tear down methods are run on the main test thread, while the<br/>\n&gt; &gt; test method is run on a different thread.<br/>\n&gt; &gt;<br/>\n&gt; &gt; This jumped out at me in a recent programming session because the class<br/>\n&gt; &gt; under test uses thread isolation to achieve thread safety, and its<br/>\n&gt; methods<br/>\n&gt; &gt; liberally assert that they are invoked on the same thread on which the<br/>\n&gt; &gt; object was instantiated. Once I realized why my timed tests were failing<br/>\n&gt; &gt; unexpectedly, I worked around the problem by moving the necessary<br/>\n&gt; portions<br/>\n&gt; &gt; of my set up and tear down to the test method itself.<br/>\n&gt; &gt;<br/>\n&gt; &gt; However, this got me thinking about more subtle issues related to timed<br/>\n&gt; &gt; tests of code that is inherently NOT thread safe. Consider the following<br/>\n&gt; &gt; contrived example, where Bar is the class under test:<br/>\n&gt; &gt;<br/>\n&gt; &gt; public class Foo {<br/>\n&gt; &gt; public void dispose() {<br/>\n&gt; &gt; }<br/>\n&gt; &gt; }<br/>\n&gt; &gt;<br/>\n&gt; &gt; public class Bar {<br/>\n&gt; &gt; private Foo foo = null;<br/>\n&gt; &gt;<br/>\n&gt; &gt; public void dispose() {<br/>\n&gt; &gt; if (foo != null) {<br/>\n&gt; &gt; foo.dispose();<br/>\n&gt; &gt; foo = null;<br/>\n&gt; &gt; }<br/>\n&gt; &gt; }<br/>\n&gt; &gt;<br/>\n&gt; &gt; public void setFoo(Foo foo) {<br/>\n&gt; &gt; this.foo = foo;<br/>\n&gt; &gt; }<br/>\n&gt; &gt; }<br/>\n&gt; &gt;<br/>\n&gt; &gt; public class BarTest {<br/>\n&gt; &gt; private Bar bar;<br/>\n&gt; &gt;<br/>\n&gt; &gt; @Before<br/>\n&gt; &gt; public void setUp() {<br/>\n&gt; &gt; bar = new Bar();<br/>\n&gt; &gt; }<br/>\n&gt; &gt;<br/>\n&gt; &gt; @Test<br/>\n&gt; &gt; public void testSomethingOnMainThread() {<br/>\n&gt; &gt; // ...<br/>\n&gt; &gt; bar.setFoo(new Foo());<br/>\n&gt; &gt; // ...<br/>\n&gt; &gt; }<br/>\n&gt; &gt;<br/>\n&gt; &gt; @Test(timeout = 1000)<br/>\n&gt; &gt; public void testSomethingOnDifferentThread() {<br/>\n&gt; &gt; // ...<br/>\n&gt; &gt; bar.setFoo(new Foo());<br/>\n&gt; &gt; // ...<br/>\n&gt; &gt; }<br/>\n&gt; &gt;<br/>\n&gt; &gt; @After<br/>\n&gt; &gt; public void tearDown() {<br/>\n&gt; &gt; bar.dispose();<br/>\n&gt; &gt; }<br/>\n&gt; &gt; }<br/>\n&gt; &gt;<br/>\n&gt; &gt; When testSomethingOnMainThread() is run, I expect the Foo instance<br/>\n&gt; created<br/>\n&gt; &gt; in the test will have its dispose() method called in tearDown() because<br/>\n&gt; its<br/>\n&gt; &gt; assignment to the Bar.foo field occurs on the same thread that invokes<br/>\n&gt; &gt; tearDown().<br/>\n&gt; &gt;<br/>\n&gt; &gt; However, when testSomethingOnDifferentThread() is run, I expect the Foo<br/>\n&gt; &gt; instance created in the test MAY NOT have its dispose() method called in<br/>\n&gt; &gt; tearDown() because its assignment to the Bar.foo field occurs on a<br/>\n&gt; &gt; different thread than the one that invokes tearDown(). Without some kind<br/>\n&gt; of<br/>\n&gt; &gt; memory barrier, the Bar.foo field may not be safely published from the<br/>\n&gt; test<br/>\n&gt; &gt; thread to the main thread.<br/>\n&gt; &gt;<br/>\n&gt; &gt; My concern is that there could be a significant change in the behavior of<br/>\n&gt; &gt; a test simply by annotating it with a timeout when the code under test is<br/>\n&gt; &gt; not thread safe. I can&#39;t be the first person to ask this question (I<br/>\n&gt; &gt; apologize if my search of this group&#39;s archives was not thorough enough),<br/>\n&gt; &gt; so I realize my entire premise may be ill-posed or that I&#39;m missing some<br/>\n&gt; &gt; fundamental understanding of the Java memory model.<br/>\n&gt; &gt;<br/>\n&gt; &gt; With that said, is it reasonable to expect that, for a given @Test, all<br/>\n&gt; &gt; @Before and @After methods in the fixture be called on the same thread<br/>\n&gt; &gt; regardless of how the test is annotated? Or is it simply up to the<br/>\n&gt; &gt; programmer to be aware of how timed tests are implemented, and to make it<br/>\n&gt; &gt; their responsibility to ensure code that is not thread safe is only ever<br/>\n&gt; &gt; invoked on a single thread, or to use external synchronization to ensure<br/>\n&gt; &gt; safe publication between threads?<br/>\n&gt; &gt;<br/>\n&gt; &gt; Cheers,<br/>\n&gt; &gt; Steve<br/>\n&gt; &gt;<br/>\n&gt; &gt; [Non-text portions of this message have been removed]<br/>\n&gt; &gt;<br/>\n&gt; &gt;<br/>\n&gt; &gt;<br/>\n&gt;<br/>\n&gt;<br/>\n&gt; [Non-text portions of this message have been removed]<br/>\n&gt;<br/>\n&gt;<br/>\n&gt;<br/>\n&gt; ------------------------------------<br/>\n&gt;<br/>\n&gt; Yahoo! Groups Links<br/>\n&gt;<br/>\n&gt;<br/>\n&gt;<br/>\n&gt;<br/>\n<br/>\n<br/>\n[Non-text portions of this message have been removed] </span></blockquote></div>", 
    "prevInTime": 24390, 
    "specialLinks": [], 
    "contentTrasformed": false, 
    "postDate": "1369411478", 
    "canDelete": false, 
    "nextInTopic": 24393, 
    "prevInTopic": 24390, 
    "headers": {
        "inReplyToHeader": "PENBTHJ3LVB6a2JPZEJlZ2FMcmd1eTF1RVlQLXpFPXhCbnlvQzUzUUF3QUVVTjU9ZFR0Z0BtYWlsLmdtYWlsLmNvbT4=", 
        "messageIdInHeader": "PENBQTNFK2VWcldwSktWMjFqdVN2dFlUUVRQM28tMTR1c0VhZnNwQlJhWjEtRmdHWjRMUUBtYWlsLmdtYWlsLmNvbT4=", 
        "referencesHeader": "PDE5MThCMTcwN0U0NjQzRThBNTAyQUJENTc2MkMzNDY1QFN0aW1weT4JPENBTHJ3LVB6a2JPZEJlZ2FMcmd1eTF1RVlQLXpFPXhCbnlvQzUzUUF3QUVVTjU9ZFR0Z0BtYWlsLmdtYWlsLmNvbT4="
    }
}