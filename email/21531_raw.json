{
    "numMessagesInTopic": 9, 
    "nextInTime": 21532, 
    "senderId": "kjltM85fsrikZYW0ZaHdK8prHoH6e5oTpSJO8v6nb9ets7XfU-9lDaEjycpfqGp6JsgHSVzawWbIEsdKT_L7bOE8MFI", 
    "systemMessage": false, 
    "subject": "RE: [junit] Race condition with timeouts", 
    "from": "&quot;kentb&quot; &lt;kentb@...&gt;", 
    "authorName": "kentb", 
    "msgSnippet": "All, Thanks for the help with the race condition. Saff fixed it by using plain old threads instead of this fancy new-fangled Future stuff. Happy testing (just", 
    "msgId": 21531, 
    "rawEmail": "Return-Path: &lt;kentb@...&gt;\r\nX-Sender: kentb@...\r\nX-Apparently-To: junit@yahoogroups.com\r\nX-Received: (qmail 88064 invoked from network); 24 Apr 2009 17:40:33 -0000\r\nX-Received: from unknown (69.147.108.202)\n  by m5.grp.sp2.yahoo.com with QMQP; 24 Apr 2009 17:40:33 -0000\r\nX-Received: from unknown (HELO elasmtp-spurfowl.atl.sa.earthlink.net) (209.86.89.66)\n  by mta3.grp.re1.yahoo.com with SMTP; 24 Apr 2009 17:40:32 -0000\r\nX-Received: from [67.42.50.124] (helo=kentspavilion)\n\tby elasmtp-spurfowl.atl.sa.earthlink.net with esmtpa (Exim 4.67)\n\t(envelope-from &lt;kentb@...&gt;)\n\tid 1LxPO3-0000Os-9d\n\tfor junit@yahoogroups.com; Fri, 24 Apr 2009 13:40:32 -0400\r\nTo: &lt;junit@yahoogroups.com&gt;\r\nReferences: &lt;CFB57F117CE94B0196CD8BF65B8F70DE@kentspavilion&gt; &lt;fba296970904100236x65dc313xdbbbef43c2cfaae5@...&gt; &lt;e9d8a2610904100658n1818fcaaye46b31194904e9b1@...&gt;\r\nDate: Fri, 24 Apr 2009 10:40:24 -0700\r\nMessage-ID: &lt;8476D82A60954E7F91B5DB1EF88FEEF3@kentspavilion&gt;\r\nMIME-Version: 1.0\r\nX-Mailer: Microsoft Office Outlook 11\r\nIn-Reply-To: &lt;e9d8a2610904100658n1818fcaaye46b31194904e9b1@...&gt;\r\nThread-Index: Acm6zyZHqnqnvfX0QAerA6BE0ML/vwKNFeGw\r\nX-MimeOLE: Produced By Microsoft MimeOLE V6.00.2900.5579\r\nX-ELNK-Trace: 6d780abf06d998e474bf435c0eb9d478eae09f65131c9d1f133009a0bc341603884ec52fe17f8dff350badd9bab72f9c350badd9bab72f9c350badd9bab72f9c\r\nX-eGroups-Msg-Info: 1:12:0:0:0\r\nFrom: &quot;kentb&quot; &lt;kentb@...&gt;\r\nReply-To: &lt;kentb@...&gt;\r\nSubject: RE: [junit] Race condition with timeouts\r\nX-Yahoo-Group-Post: member; u=173198504; y=tx3JSu8KMPEOoh9onH-ipgtzYLMGWjXdV_gbQgrWy_f8pT-i\r\nX-Yahoo-Profile: kentlbeck\r\nContent-Type: text/plain; charset=ISO-8859-1\r\nContent-Transfer-Encoding: quoted-printable\r\n\r\nAll,\n \nThanks for the help with the race condition. Saff fixed it by using =\r\nplain\nold threads instead of this fancy new-fangled Future stuff.\n \nHappy t=\r\nesting (just not too long)!\n \nKent\n\n  _____  \n\nFrom: junit@yahoogroups.com =\r\n[mailto:junit@yahoogroups.com] On Behalf Of\nGilles Scokart\nSent: Friday, Ap=\r\nril 10, 2009 6:58 AM\nTo: junit@yahoogroups.com\nSubject: Re: [junit] Race co=\r\nndition with timeouts\n\n\n\n\n\nWhy do you need this first :\n\nservice.awaitTermi=\r\nnation(fTimeout, TimeUnit.MILLISECONDS);\n\nMaybe just :\n\nresult.get(0, TimeU=\r\nnit.MILLISECONDS);\n\nwith a shutdownNow after in a finally block if required=\r\n.\n\nI would expect you always get InterrpuptedException because you are send=\r\ning\nit to the service thread via shutdownNow. Once you get the result from =\r\nyour\nFuture, you should get it.\nHowever, I guess that because your timeout =\r\nis very small, the get method\nmight times out before the service thread is =\r\nreactivated. So in those case,\nyou get only your TimeOut and throw your exc=\r\neption.\n\nGilles Scokart\n\n2009/4/10 Ilja Preu=DF &lt;iljapreuss@googlema\n&lt;mailt=\r\no:iljapreuss%40googlemail.com&gt; il.com&gt;\n\n&gt;\n&gt;\n&gt; I&#39;m assuming that the Interru=\r\nptedException is caused by\n&gt; service.shutdownNow(), which, according to jav=\r\nadoc, &quot;typical\n&gt; implementations will cancel via Thread.interrupt()&quot;.\n&gt;\n&gt; W=\r\nhat is causing the TimeoutException? Unfortunately, your code throws\n&gt; away=\r\n the original stacktrace, and I don&#39;t know the executor API well\n&gt; enough t=\r\no guess...\n&gt;\n&gt; Cheers, Ilja\n&gt;\n&gt; 2009/4/9 kentb &lt;kentb@earthlink. &lt;mailto:ke=\r\nntb%40earthlink.net&gt; net\n&lt;kentb%40earthlink.net&gt;&gt;:\n&gt;\n&gt; &gt;\n&gt; &gt;\n&gt; &gt; All,\n&gt; &gt;\n&gt;=\r\n &gt; This is a test of the &quot;with enough eyeballs, all bugs are shallow&quot;\n&gt; &gt; h=\r\nypothesis.\n&gt; &gt;\n&gt; &gt; I am experiencing a race condition with timeouts. Say I =\r\nhave a test like\n&gt; &gt; this:\n&gt; &gt;\n&gt; &gt; public class WaitTooLong {\n&gt; &gt; @Test(tim=\r\neout=3D10) public void ripVanWinkle() throws\n&gt; &gt; InterruptedException {\n&gt; &gt;=\r\n Thread.sleep(100);\n&gt; &gt; }\n&gt; &gt; }\n&gt; &gt;\n&gt; &gt; When I run this I get one of two er=\r\nrors, non-deterministically:\n&gt; &gt;\n&gt; &gt; java.lang.InterruptedException: sleep =\r\ninterrupted\n&gt; &gt; at java.lang.Thread.sleep(Native Method)\n&gt; &gt; at Unpredictab=\r\nleTest.takeTen(UnpredictableTest.java:5)\n&gt; &gt; ...\n&gt; &gt;\n&gt; &gt; or\n&gt; &gt;\n&gt; &gt; java.la=\r\nng.Exception: test timed out after 10 milliseconds\n&gt; &gt; at\n&gt; &gt;\n&gt;\norg.junit.i=\r\nnternal.runners.statements.FailOnTimeout.evaluate(FailOnTimeout.j\n&gt; &gt; ava:4=\r\n8)\n&gt; &gt; ...\n&gt; &gt;\n&gt; &gt; Here&#39;s the relevant code in JUnit (FailOnTimeout):\n&gt; &gt;\n&gt;=\r\n &gt; public void evaluate() throws Throwable {\n&gt; &gt; ExecutorService service=3D=\r\n\n&gt; &gt; Executors.newSingleThreadExecutor();\n&gt; &gt; Callable&lt;Object&gt; callable=3D =\r\nnew Callable&lt;Object&gt;() {\n&gt; &gt; public Object call() throws Exception {\n&gt; &gt; tr=\r\ny {\n&gt; &gt; fNext.evaluate();\n&gt; &gt; } catch (Throwable e) {\n&gt; &gt; throw new Executi=\r\nonException(e);\n&gt; &gt; }\n&gt; &gt; return null;\n&gt; &gt; }\n&gt; &gt; };\n&gt; &gt; Future&lt;Object&gt; resu=\r\nlt=3D service.submit(callable);\n&gt; &gt; service.shutdown();\n&gt; &gt; try {\n&gt; &gt; boole=\r\nan terminated=3D\n&gt; &gt; service.awaitTermination(fTimeout, TimeUnit.MILLISECON=\r\nDS);\n&gt; &gt; if (!terminated)\n&gt; &gt; service.shutdownNow();\n&gt; &gt; result.get(0, Time=\r\nUnit.MILLISECONDS); // throws the\n&gt; &gt; exception if one occurred during the =\r\ninvocation\n&gt; &gt; } catch (TimeoutException e) {\n&gt; &gt; throw new Exception(Strin=\r\ng.format(&quot;test timed out\n&gt; &gt; after %d milliseconds&quot;, fTimeout));\n&gt; &gt; } catc=\r\nh (ExecutionException e) {\n&gt; &gt; throw unwrap(e);\n&gt; &gt; }\n&gt; &gt; }\n&gt; &gt;\n&gt; &gt; It seem=\r\ns that sometimes the TimeoutException gets thrown and caught and\n&gt; the\n&gt; &gt; =\r\nException thrown. Sometimes, though, the InterruptedException that is\n&gt; &gt; t=\r\nerminating the test-running thread gets thrown/caught first. I&#39;ve\nstared\n&gt; =\r\nat\n&gt; &gt; this enough minutes to be ready for help.\n&gt; &gt;\n&gt; &gt; One strangeness is=\r\n that if I run the test programmatically\n&gt; &gt; (&quot;JUnitCore.runClass(WaitTooLo=\r\nng.class)&quot;) the Exception is always\nthrown.\n&gt; If\n&gt; &gt; I run the test with th=\r\ne Eclipse JUnit runner or with JUnit Max, the\n&gt; results\n&gt; &gt; are non-determi=\r\nnistic.\n&gt; &gt;\n&gt; &gt; Any ideas for making this deterministic? I would prefer the=\r\n second\nresult\n&gt; &gt; above, if I can get it.\n&gt; &gt;\n&gt; &gt; Regards,\n&gt; &gt;\n&gt; &gt; Kent Be=\r\nck\n&gt; &gt; Three Rivers Institute\n&gt; &gt;\n&gt; &gt;\n&gt; \n&gt;\n\n[Non-text portions of this mess=\r\nage have been removed]\n\n\n\n\n\n\n[Non-text portions of this message have been r=\r\nemoved]\n\n\n", 
    "profile": "kentlbeck", 
    "topicId": 21487, 
    "spamInfo": {
        "reason": "12", 
        "isSpam": false
    }, 
    "replyTo": "LIST", 
    "userId": 173198504, 
    "prevInTime": 21530, 
    "contentTrasformed": false, 
    "postDate": "1240594824", 
    "canDelete": false, 
    "nextInTopic": 0, 
    "prevInTopic": 21494, 
    "headers": {
        "inReplyToHeader": "PGU5ZDhhMjYxMDkwNDEwMDY1OG4xODE4ZmNhYXllNDZiMzExOTQ5MDRlOWIxQG1haWwuZ21haWwuY29tPg==", 
        "messageIdInHeader": "PDg0NzZEODJBNjA5NTRFN0Y5MUI1REIxRUY4OEZFRUYzQGtlbnRzcGF2aWxpb24+", 
        "referencesHeader": "PENGQjU3RjExN0NFOTRCMDE5NkNEOEJGNjVCOEY3MERFQGtlbnRzcGF2aWxpb24+IDxmYmEyOTY5NzA5MDQxMDAyMzZ4NjVkYzMxM3hkYmJiZWY0M2MyY2ZhYWU1QG1haWwuZ21haWwuY29tPiA8ZTlkOGEyNjEwOTA0MTAwNjU4bjE4MThmY2FheWU0NmIzMTE5NDkwNGU5YjFAbWFpbC5nbWFpbC5jb20+"
    }
}