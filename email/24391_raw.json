{
    "numMessagesInTopic": 6, 
    "nextInTime": 24392, 
    "senderId": "Cxi6fS90cvZk4hwyGIl5T-UiNlwVDFTOKp0sfjmCZR3qFEmmwxTjprMHoIdaoBn4qQp6XfojsQDXynrktEYQsRmIa2EzR0J9", 
    "systemMessage": true, 
    "subject": "Re: [junit] Timed Tests and Thread Safety", 
    "from": "Kevin Cooney &lt;kcooney@...&gt;", 
    "authorName": "Kevin Cooney", 
    "msgSnippet": "Note the Timeout rule will call @Before and @After methods in the same thread as the test. The test class is created before rules are applied, so if your test", 
    "msgId": 24391, 
    "rawEmail": "Return-Path: &lt;kcooney@...&gt;\r\nReceived: (qmail 60620 invoked by uid 102); 24 May 2013 16:48:31 -0000\r\nReceived: from unknown (HELO mtaq6.grp.bf1.yahoo.com) (10.193.84.37)\n  by m9.grp.bf1.yahoo.com with SMTP; 24 May 2013 16:48:31 -0000\r\nReceived: (qmail 30790 invoked from network); 24 May 2013 16:48:31 -0000\r\nReceived: from unknown (HELO ng20-vm1.bullet.mail.ne1.yahoo.com) (98.138.214.210)\n  by mtaq6.grp.bf1.yahoo.com with SMTP; 24 May 2013 16:48:31 -0000\r\nDKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed; d=yahoogroups.com; s=echoe; t=1369414111; bh=mcQNUGpvzfPNPvysvvpWHW53rlIEbLQfl/7htHMpVWY=; h=Received:Received:X-Sender:X-Apparently-To:X-Received:X-Received:X-Received:X-Received:X-Received:X-Google-DKIM-Signature:MIME-Version:X-Received:X-Received:X-Received:In-Reply-To:References:Date:Message-ID:To:X-Gm-Message-State:X-Originating-IP:X-eGroups-Msg-Info:From:Subject:X-Yahoo-Group-Post:X-Yahoo-Profile:Content-Type:Content-Transfer-Encoding:X-YGroups-SubInfo:Sender:X-Yahoo-Newman-Property:X-eGroups-Approved-By:X-eGroups-Auth; b=cgZx/NnCDfs63Q4JCWJmEcimZJsqYJ6dbKIU9WeEoWoPkg8qQ8/RZtIIzal2ogWojjctaNzBAVlC1P5V7DSYvhqocVQi4dPb84DsP24nRdomcCY8hIrkWfoMiC3SlxNUOHaxGUE2osmkbvaD7osE4LVVBXuCDNO8DyuTuca7ieM=\r\nReceived: from [98.138.217.178] by ng20.bullet.mail.ne1.yahoo.com with NNFMP; 24 May 2013 16:48:31 -0000\r\nReceived: from [10.193.94.46] by tg3.bullet.mail.ne1.yahoo.com with NNFMP; 24 May 2013 16:48:31 -0000\r\nX-Sender: kcooney@...\r\nX-Apparently-To: junit@yahoogroups.com\r\nX-Received: (qmail 26369 invoked by uid 102); 24 May 2013 16:04:39 -0000\r\nX-Received: from unknown (HELO mtaq4.grp.bf1.yahoo.com) (10.193.84.143)\n  by m12.grp.bf1.yahoo.com with SMTP; 24 May 2013 16:04:39 -0000\r\nX-Received: (qmail 1820 invoked from network); 24 May 2013 16:04:39 -0000\r\nX-Received: from unknown (HELO mail-la0-f42.google.com) (209.85.215.42)\n  by mtaq4.grp.bf1.yahoo.com with SMTP; 24 May 2013 16:04:39 -0000\r\nX-Received: by mail-la0-f42.google.com with SMTP id fg20so4663400lab.29\n        for &lt;junit@yahoogroups.com&gt;; Fri, 24 May 2013 09:04:38 -0700 (PDT)\r\nX-Google-DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed;\n        d=google.com; s=20120113;\n        h=mime-version:in-reply-to:references:date:message-id:subject:from:to\n         :content-type:x-gm-message-state;\n        bh=aXniu25F5XAowzMJWeU2FR0tYOOCr8ddtHD8hmGSSrk=;\n        b=WZFjIlyaNl/ibaOinslpB6h7DNgjlOT5BxRki3tB1LnmjFEbARu8IENQf4UQzRx/W5\n         /jYb4bTAdF4tomSkJ/1tArxQd3GsgVtlZzq8Em9mSM+fq5gJCijEh4RVdXvtDWIthNNI\n         kmfiJGt0NFpqc3wljYwX0au54DNFHir3Dh9pYmFHTkp/VFhCl7/TSMVlHdRE6cQHadtb\n         Jw73fOJrgQ45N8WCxUMYpb16OWS1BUgPp9B71UFr7s+lSG5FHlACDv/1O1hxvfpY/lJK\n         12vTnV9Y9PT1D9aAT1jUiNH3oGG+U/mqQvDuqKZ7DZDT0s8ogKhjZaJwi9A7nDkNVBeb\n         jDLA==\r\nMIME-Version: 1.0\r\nX-Received: by 10.112.156.133 with SMTP id we5mr9332024lbb.22.1369411478342;\n Fri, 24 May 2013 09:04:38 -0700 (PDT)\r\nX-Received: by 10.152.114.67 with HTTP; Fri, 24 May 2013 09:04:38 -0700 (PDT)\r\nX-Received: by 10.152.114.67 with HTTP; Fri, 24 May 2013 09:04:38 -0700 (PDT)\r\nIn-Reply-To: &lt;CALrw-PzkbOdBegaLrguy1uEYP-zE=xBnyoC53QAwAEUN5=dTtg@...&gt;\r\nReferences: &lt;1918B1707E4643E8A502ABD5762C3465@Stimpy&gt;\n\t&lt;CALrw-PzkbOdBegaLrguy1uEYP-zE=xBnyoC53QAwAEUN5=dTtg@...&gt;\r\nDate: Fri, 24 May 2013 09:04:38 -0700\r\nMessage-ID: &lt;CAA3E+eVrWpJKV21juSvtYTQTP3o-14usEafspBRaZ1-FgGZ4LQ@...&gt;\r\nTo: junit@yahoogroups.com\r\nX-Gm-Message-State: ALoCoQkpiK6W+YeD06A5P8IAZUeZciy/Fga0AHXNbmaBBR7l7oLVHxgcE5nC33XdbNlLJ0/NgSdnunQTPvTHbKo/oglRayUXQ31OHeVro7DKARESQ5v7tAkYq7KxdpTrYUWf94CeNwzk5BuP/pWnRlM3wRlVDiIo9qOK7Md8gz9TjOaQ+uqR8cXaNo10XtRn4U6pdpUET8ds\r\nX-eGroups-Msg-Info: 1:12:0:0:0\r\nFrom: Kevin Cooney &lt;kcooney@...&gt;\r\nSubject: Re: [junit] Timed Tests and Thread Safety\r\nX-Yahoo-Group-Post: member; u=475263748; y=RWIDBnjuyLqfp-ARkD_AxJgPvKy-FrlqDUrctVczpEUU_25aPGmNJW8Thucz_1V1bp3g10phKnGSZNU\r\nX-Yahoo-Profile: kevincooney2000\r\nContent-Type: text/plain; charset=US-ASCII\r\nContent-Transfer-Encoding: 7bit\r\nX-Yahoo-Newman-Property: groups-system\r\nX-eGroups-Approved-By: spchappell &lt;simonpeterchappell@...&gt; via web; 24 May 2013 16:48:30 -0000\r\n\r\nNote the Timeout rule will call @Before and @After methods in the same\nthread as the test. The test class is created before rules are applied, so\nif your test class initializes fields at declaration time, that execution\nwould happen in a different thread than the test.\n\nI also believe that @After methods would not be called for tests methods\nthat timeout in classes that use the Timeout rule.\n\n- Kevin\nOn May 24, 2013 8:25 AM, &quot;David Saff&quot; &lt;saff@...&gt; wrote:\n\n&gt; Steve,\n&gt;\n&gt; You raise a great question.  Unfortunately, and perhaps I&#39;m missing\n&gt; something obvious, I don&#39;t think there&#39;s a way to provide timeout\n&gt; semantics, guarantee that @After is called, and guarantee that @After is\n&gt; called on the same thread as the @Test method.  Essentially, once the\n&gt; runner hands over control to the @Test thread, there&#39;s no guarantee that it\n&gt; will ever return control back--it could go into an infinite loop that\n&gt; catches InterruptedExceptions.\n&gt;\n&gt; It would potentially be possible to guarantee that successful tests that\n&gt; complete within the timeout have @After methods called on the same thread,\n&gt; but that would further complicate matters, with questionable (IMHO) payoff.\n&gt;\n&gt; The biggest payoff would probably be to make sure that the documentation we\n&gt; have makes it easy to avoid any unexpected behavior.  Can you suggest an\n&gt; edit to that effect?  Thanks,\n&gt;\n&gt;    David Saff\n&gt;\n&gt;\n&gt; On Thu, May 23, 2013 at 8:34 PM, Steven Soloff &lt;s_soloff@...\n&gt; &gt;wrote:\n&gt;\n&gt; &gt; **\n&gt; &gt;\n&gt; &gt;\n&gt; &gt; Hi All,\n&gt; &gt;\n&gt; &gt; I&#39;ve been using timed tests (i.e. @Test(timeout = ...)) for years but\n&gt; &gt; recently came across an implementation detail of which I was unaware.\n&gt; While\n&gt; &gt; I knew that timed tests are run in a thread other than the main test\n&gt; &gt; thread, I assumed that all aspects of the test (set up, test, and tear\n&gt; &gt; down) were run in that other thread. I was surprised to discover that the\n&gt; &gt; set up and tear down methods are run on the main test thread, while the\n&gt; &gt; test method is run on a different thread.\n&gt; &gt;\n&gt; &gt; This jumped out at me in a recent programming session because the class\n&gt; &gt; under test uses thread isolation to achieve thread safety, and its\n&gt; methods\n&gt; &gt; liberally assert that they are invoked on the same thread on which the\n&gt; &gt; object was instantiated. Once I realized why my timed tests were failing\n&gt; &gt; unexpectedly, I worked around the problem by moving the necessary\n&gt; portions\n&gt; &gt; of my set up and tear down to the test method itself.\n&gt; &gt;\n&gt; &gt; However, this got me thinking about more subtle issues related to timed\n&gt; &gt; tests of code that is inherently NOT thread safe. Consider the following\n&gt; &gt; contrived example, where Bar is the class under test:\n&gt; &gt;\n&gt; &gt; public class Foo {\n&gt; &gt; public void dispose() {\n&gt; &gt; }\n&gt; &gt; }\n&gt; &gt;\n&gt; &gt; public class Bar {\n&gt; &gt; private Foo foo = null;\n&gt; &gt;\n&gt; &gt; public void dispose() {\n&gt; &gt; if (foo != null) {\n&gt; &gt; foo.dispose();\n&gt; &gt; foo = null;\n&gt; &gt; }\n&gt; &gt; }\n&gt; &gt;\n&gt; &gt; public void setFoo(Foo foo) {\n&gt; &gt; this.foo = foo;\n&gt; &gt; }\n&gt; &gt; }\n&gt; &gt;\n&gt; &gt; public class BarTest {\n&gt; &gt; private Bar bar;\n&gt; &gt;\n&gt; &gt; @Before\n&gt; &gt; public void setUp() {\n&gt; &gt; bar = new Bar();\n&gt; &gt; }\n&gt; &gt;\n&gt; &gt; @Test\n&gt; &gt; public void testSomethingOnMainThread() {\n&gt; &gt; // ...\n&gt; &gt; bar.setFoo(new Foo());\n&gt; &gt; // ...\n&gt; &gt; }\n&gt; &gt;\n&gt; &gt; @Test(timeout = 1000)\n&gt; &gt; public void testSomethingOnDifferentThread() {\n&gt; &gt; // ...\n&gt; &gt; bar.setFoo(new Foo());\n&gt; &gt; // ...\n&gt; &gt; }\n&gt; &gt;\n&gt; &gt; @After\n&gt; &gt; public void tearDown() {\n&gt; &gt; bar.dispose();\n&gt; &gt; }\n&gt; &gt; }\n&gt; &gt;\n&gt; &gt; When testSomethingOnMainThread() is run, I expect the Foo instance\n&gt; created\n&gt; &gt; in the test will have its dispose() method called in tearDown() because\n&gt; its\n&gt; &gt; assignment to the Bar.foo field occurs on the same thread that invokes\n&gt; &gt; tearDown().\n&gt; &gt;\n&gt; &gt; However, when testSomethingOnDifferentThread() is run, I expect the Foo\n&gt; &gt; instance created in the test MAY NOT have its dispose() method called in\n&gt; &gt; tearDown() because its assignment to the Bar.foo field occurs on a\n&gt; &gt; different thread than the one that invokes tearDown(). Without some kind\n&gt; of\n&gt; &gt; memory barrier, the Bar.foo field may not be safely published from the\n&gt; test\n&gt; &gt; thread to the main thread.\n&gt; &gt;\n&gt; &gt; My concern is that there could be a significant change in the behavior of\n&gt; &gt; a test simply by annotating it with a timeout when the code under test is\n&gt; &gt; not thread safe. I can&#39;t be the first person to ask this question (I\n&gt; &gt; apologize if my search of this group&#39;s archives was not thorough enough),\n&gt; &gt; so I realize my entire premise may be ill-posed or that I&#39;m missing some\n&gt; &gt; fundamental understanding of the Java memory model.\n&gt; &gt;\n&gt; &gt; With that said, is it reasonable to expect that, for a given @Test, all\n&gt; &gt; @Before and @After methods in the fixture be called on the same thread\n&gt; &gt; regardless of how the test is annotated? Or is it simply up to the\n&gt; &gt; programmer to be aware of how timed tests are implemented, and to make it\n&gt; &gt; their responsibility to ensure code that is not thread safe is only ever\n&gt; &gt; invoked on a single thread, or to use external synchronization to ensure\n&gt; &gt; safe publication between threads?\n&gt; &gt;\n&gt; &gt; Cheers,\n&gt; &gt; Steve\n&gt; &gt;\n&gt; &gt; [Non-text portions of this message have been removed]\n&gt; &gt;\n&gt; &gt;\n&gt; &gt;\n&gt;\n&gt;\n&gt; [Non-text portions of this message have been removed]\n&gt;\n&gt;\n&gt;\n&gt; ------------------------------------\n&gt;\n&gt; Yahoo! Groups Links\n&gt;\n&gt;\n&gt;\n&gt;\n\n\n[Non-text portions of this message have been removed]\n\n\n", 
    "profile": "kevincooney2000", 
    "topicId": 24388, 
    "spamInfo": {
        "reason": "12", 
        "isSpam": false
    }, 
    "replyTo": "LIST", 
    "userId": 475263748, 
    "prevInTime": 24390, 
    "contentTrasformed": false, 
    "postDate": "1369411478", 
    "canDelete": false, 
    "nextInTopic": 24393, 
    "prevInTopic": 24390, 
    "headers": {
        "inReplyToHeader": "PENBTHJ3LVB6a2JPZEJlZ2FMcmd1eTF1RVlQLXpFPXhCbnlvQzUzUUF3QUVVTjU9ZFR0Z0BtYWlsLmdtYWlsLmNvbT4=", 
        "messageIdInHeader": "PENBQTNFK2VWcldwSktWMjFqdVN2dFlUUVRQM28tMTR1c0VhZnNwQlJhWjEtRmdHWjRMUUBtYWlsLmdtYWlsLmNvbT4=", 
        "referencesHeader": "PDE5MThCMTcwN0U0NjQzRThBNTAyQUJENTc2MkMzNDY1QFN0aW1weT4JPENBTHJ3LVB6a2JPZEJlZ2FMcmd1eTF1RVlQLXpFPXhCbnlvQzUzUUF3QUVVTjU9ZFR0Z0BtYWlsLmdtYWlsLmNvbT4="
    }
}