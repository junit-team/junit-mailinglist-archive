{
    "numMessagesInTopic": 6, 
    "nextInTime": 24390, 
    "senderId": "5GJDToRy42dr8CDpf2B2YSVY66aotYkZ4E052Zm9JbDmQP8iTcQ4X6yaBuKLZ5-WsIfoz8SVW-XLKyGnY_Cei9opLw", 
    "systemMessage": false, 
    "subject": "Re: [junit] Timed Tests and Thread Safety", 
    "from": "David Saff &lt;saff@...&gt;", 
    "authorName": "David Saff", 
    "msgSnippet": "Steve, You raise a great question.  Unfortunately, and perhaps I m missing something obvious, I don t think there s a way to provide timeout semantics,", 
    "msgId": 24389, 
    "rawEmail": "Return-Path: &lt;saff@...&gt;\r\nX-Sender: saff@...\r\nX-Apparently-To: junit@yahoogroups.com\r\nX-Received: (qmail 48420 invoked by uid 102); 24 May 2013 15:25:11 -0000\r\nX-Received: from unknown (HELO mtaq1.grp.bf1.yahoo.com) (10.193.84.32)\n  by m7.grp.bf1.yahoo.com with SMTP; 24 May 2013 15:25:11 -0000\r\nX-Received: (qmail 24445 invoked from network); 24 May 2013 15:25:11 -0000\r\nX-Received: from unknown (HELO mail-oa0-f49.google.com) (209.85.219.49)\n  by mtaq1.grp.bf1.yahoo.com with SMTP; 24 May 2013 15:25:11 -0000\r\nX-Received: by mail-oa0-f49.google.com with SMTP id k14so6218390oag.22\n        for &lt;junit@yahoogroups.com&gt;; Fri, 24 May 2013 08:25:10 -0700 (PDT)\r\nX-Google-DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed;\n        d=google.com; s=20120113;\n        h=mime-version:in-reply-to:references:from:date:message-id:subject:to\n         :content-type:x-gm-message-state;\n        bh=FXk6sBAIaHK5b7uksTzt2UhcCZ45HtR+3m12cbRmrIQ=;\n        b=iuAmC7MqwRvf/mI52B8LskatGUheSzRn806O/28J+aQDnIhWjMh1Z52QWe0cvk3NZV\n         5nyH7Ke8cCUisRCU7dj+3ec8V6Yh/LcP9GpPUUO5wDxMwgVqqBur/QGOwDBvI+9mVyVx\n         EADjNJMFPzm6Xbj2ueB0HINtP6kNPKb9T0dvLqqTZTRIEiJphI4pTZW3S+IYl1Tm4u2E\n         t6+MtRywQhqJb7Qve34WRjGhJRn/Up1bA0S3xPhA5TUKkRB/W0ixw0VcL1ss+R7rQ/MJ\n         usTpOqkPCgkQUH50LqTNF7MN9BJCJ2YEy+GQsZQ7BQg8RlCmx6JiBF9vV4W+1Y2Az0jn\n         d3fg==\r\nX-Received: by 10.60.43.101 with SMTP id v5mr11119198oel.54.1369409110744;\n Fri, 24 May 2013 08:25:10 -0700 (PDT)\r\nMIME-Version: 1.0\r\nX-Received: by 10.182.158.234 with HTTP; Fri, 24 May 2013 08:24:50 -0700 (PDT)\r\nIn-Reply-To: &lt;1918B1707E4643E8A502ABD5762C3465@Stimpy&gt;\r\nReferences: &lt;1918B1707E4643E8A502ABD5762C3465@Stimpy&gt;\r\nDate: Fri, 24 May 2013 11:24:50 -0400\r\nMessage-ID: &lt;CALrw-PzkbOdBegaLrguy1uEYP-zE=xBnyoC53QAwAEUN5=dTtg@...&gt;\r\nTo: junit@yahoogroups.com\r\nX-Gm-Message-State: ALoCoQl4dMxCVpiZ5vJpLe1U2WwPX+02DaBA7bg+RE9wbUx6PD5sl29rSHdmR4o7n9HhrjqEiCgrJJjNwf14ZcUcnqnbWzIjgNi6fj86RVw7VorehGmaksDolyPa3DjAfF9p3EWDnWjrpd21xwxV0v7fvZGVPnFCYgk2nZrN4k4mHCySdvvVkWk07+9hJRX5lqfzctgAs3Sh\r\nX-eGroups-Msg-Info: 1:12:0:0:0\r\nFrom: David Saff &lt;saff@...&gt;\r\nSubject: Re: [junit] Timed Tests and Thread Safety\r\nX-Yahoo-Group-Post: member; u=525765722; y=BPKv9rFJt90UIlI6KJ4EktzKPZaJLO5kFGqGaZmaKV_SJA65pOuQr-X10S283WbbMcU20zT2I3beUsE\r\nX-Yahoo-Profile: saffatgoogle\r\nContent-Type: text/plain\r\nContent-Transfer-Encoding: quoted-printable\r\n\r\nSteve,\n\nYou raise a great question.  Unfortunately, and perhaps I&#39;m missing=\r\n\nsomething obvious, I don&#39;t think there&#39;s a way to provide timeout\nsemantic=\r\ns, guarantee that @After is called, and guarantee that @After is\ncalled on =\r\nthe same thread as the @Test method.  Essentially, once the\nrunner hands ov=\r\ner control to the @Test thread, there&#39;s no guarantee that it\nwill ever retu=\r\nrn control back--it could go into an infinite loop that\ncatches Interrupted=\r\nExceptions.\n\nIt would potentially be possible to guarantee that successful =\r\ntests that\ncomplete within the timeout have @After methods called on the sa=\r\nme thread,\nbut that would further complicate matters, with questionable (IM=\r\nHO) payoff.\n\nThe biggest payoff would probably be to make sure that the doc=\r\numentation we\nhave makes it easy to avoid any unexpected behavior.  Can you=\r\n suggest an\nedit to that effect?  Thanks,\n\n   David Saff\n\n\nOn Thu, May 23, =\r\n2013 at 8:34 PM, Steven Soloff &lt;s_soloff@...&gt;wrote:\n\n&gt; **\n&gt;\n&gt;\n&gt; H=\r\ni All,\n&gt;\n&gt; I&#39;ve been using timed tests (i.e. @Test(timeout =3D ...)) for ye=\r\nars but\n&gt; recently came across an implementation detail of which I was unaw=\r\nare. While\n&gt; I knew that timed tests are run in a thread other than the mai=\r\nn test\n&gt; thread, I assumed that all aspects of the test (set up, test, and =\r\ntear\n&gt; down) were run in that other thread. I was surprised to discover tha=\r\nt the\n&gt; set up and tear down methods are run on the main test thread, while=\r\n the\n&gt; test method is run on a different thread.\n&gt;\n&gt; This jumped out at me =\r\nin a recent programming session because the class\n&gt; under test uses thread =\r\nisolation to achieve thread safety, and its methods\n&gt; liberally assert that=\r\n they are invoked on the same thread on which the\n&gt; object was instantiated=\r\n. Once I realized why my timed tests were failing\n&gt; unexpectedly, I worked =\r\naround the problem by moving the necessary portions\n&gt; of my set up and tear=\r\n down to the test method itself.\n&gt;\n&gt; However, this got me thinking about mo=\r\nre subtle issues related to timed\n&gt; tests of code that is inherently NOT th=\r\nread safe. Consider the following\n&gt; contrived example, where Bar is the cla=\r\nss under test:\n&gt;\n&gt; public class Foo {\n&gt; public void dispose() {\n&gt; }\n&gt; }\n&gt;\n&gt;=\r\n public class Bar {\n&gt; private Foo foo =3D null;\n&gt;\n&gt; public void dispose() {=\r\n\n&gt; if (foo !=3D null) {\n&gt; foo.dispose();\n&gt; foo =3D null;\n&gt; }\n&gt; }\n&gt;\n&gt; public=\r\n void setFoo(Foo foo) {\n&gt; this.foo =3D foo;\n&gt; }\n&gt; }\n&gt;\n&gt; public class BarTes=\r\nt {\n&gt; private Bar bar;\n&gt;\n&gt; @Before\n&gt; public void setUp() {\n&gt; bar =3D new Ba=\r\nr();\n&gt; }\n&gt;\n&gt; @Test\n&gt; public void testSomethingOnMainThread() {\n&gt; // ...\n&gt; b=\r\nar.setFoo(new Foo());\n&gt; // ...\n&gt; }\n&gt;\n&gt; @Test(timeout =3D 1000)\n&gt; public voi=\r\nd testSomethingOnDifferentThread() {\n&gt; // ...\n&gt; bar.setFoo(new Foo());\n&gt; //=\r\n ...\n&gt; }\n&gt;\n&gt; @After\n&gt; public void tearDown() {\n&gt; bar.dispose();\n&gt; }\n&gt; }\n&gt;\n&gt;=\r\n When testSomethingOnMainThread() is run, I expect the Foo instance created=\r\n\n&gt; in the test will have its dispose() method called in tearDown() because =\r\nits\n&gt; assignment to the Bar.foo field occurs on the same thread that invoke=\r\ns\n&gt; tearDown().\n&gt;\n&gt; However, when testSomethingOnDifferentThread() is run, =\r\nI expect the Foo\n&gt; instance created in the test MAY NOT have its dispose() =\r\nmethod called in\n&gt; tearDown() because its assignment to the Bar.foo field o=\r\nccurs on a\n&gt; different thread than the one that invokes tearDown(). Without=\r\n some kind of\n&gt; memory barrier, the Bar.foo field may not be safely publish=\r\ned from the test\n&gt; thread to the main thread.\n&gt;\n&gt; My concern is that there =\r\ncould be a significant change in the behavior of\n&gt; a test simply by annotat=\r\ning it with a timeout when the code under test is\n&gt; not thread safe. I can&#39;=\r\nt be the first person to ask this question (I\n&gt; apologize if my search of t=\r\nhis group&#39;s archives was not thorough enough),\n&gt; so I realize my entire pre=\r\nmise may be ill-posed or that I&#39;m missing some\n&gt; fundamental understanding =\r\nof the Java memory model.\n&gt;\n&gt; With that said, is it reasonable to expect th=\r\nat, for a given @Test, all\n&gt; @Before and @After methods in the fixture be c=\r\nalled on the same thread\n&gt; regardless of how the test is annotated? Or is i=\r\nt simply up to the\n&gt; programmer to be aware of how timed tests are implemen=\r\nted, and to make it\n&gt; their responsibility to ensure code that is not threa=\r\nd safe is only ever\n&gt; invoked on a single thread, or to use external synchr=\r\nonization to ensure\n&gt; safe publication between threads?\n&gt;\n&gt; Cheers,\n&gt; Steve=\r\n\n&gt;\n&gt; [Non-text portions of this message have been removed]\n&gt;\n&gt;  \n&gt;\n\n\n[Non-t=\r\next portions of this message have been removed]\n\n\n", 
    "profile": "saffatgoogle", 
    "topicId": 24388, 
    "spamInfo": {
        "reason": "12", 
        "isSpam": false
    }, 
    "replyTo": "LIST", 
    "userId": 525765722, 
    "prevInTime": 24388, 
    "contentTrasformed": false, 
    "postDate": "1369409090", 
    "canDelete": false, 
    "nextInTopic": 24390, 
    "prevInTopic": 24388, 
    "headers": {
        "inReplyToHeader": "PDE5MThCMTcwN0U0NjQzRThBNTAyQUJENTc2MkMzNDY1QFN0aW1weT4=", 
        "messageIdInHeader": "PENBTHJ3LVB6a2JPZEJlZ2FMcmd1eTF1RVlQLXpFPXhCbnlvQzUzUUF3QUVVTjU9ZFR0Z0BtYWlsLmdtYWlsLmNvbT4=", 
        "referencesHeader": "PDE5MThCMTcwN0U0NjQzRThBNTAyQUJENTc2MkMzNDY1QFN0aW1weT4="
    }
}