{
    "numMessagesInTopic": 1, 
    "nextInTime": 14050, 
    "senderId": "c_jde11ktlazKMT7-1tsnTrVuIANkVQKObAjsAH2C3xxhciP9F6fSKzpIfH5S1sScFWjrZRE0rb4JmcXihnOYUwJbAhsR-A8TbzayQnc", 
    "systemMessage": false, 
    "subject": "Re: [junit] Using a Special Class Loader to test a Singleton", 
    "from": "Neil Swingler &lt;neil@...&gt;", 
    "authorName": "Neil Swingler", 
    "msgSnippet": "... If you are going to use reflection to defeat the private constructor, why bother reloading the class. ... The problem is that", 
    "msgId": 14049, 
    "profile": "neil_swingler", 
    "topicId": 14049, 
    "spamInfo": {
        "reason": "12", 
        "isSpam": false
    }, 
    "replyTo": "LIST", 
    "userId": 117993331, 
    "messageBody": "<div id=\"ygrps-yiv-2012137535\"><blockquote><span title=\"ireply\">&gt; I know that the JUnit community frowns on Singletons.  However I have<br/>\n&gt; a piece of code which uses a singleton, and I want to test it.  The<br/>\n&gt; singleton takes a &quot;Reader&quot; in it&#39;s constructor (which may be null, and<br/>\n&gt; then it uses a properties file to create its data).  I want to test it<br/>\n&gt; using various different data sets.  In line with that, I created a<br/>\n&gt; custom Class Loader, and use Reflection to create the object.  It<br/>\n&gt; works great (except, of course, where it doesn&#39;t).  The reflexively<br/>\n&gt; obtained constructor returns an object of type &#39;Object&#39;, which the<br/>\n&gt; debugger says has the correct underlying type, and it contains the<br/>\n&gt; correct data, but I cannot Cast it to the type it needs to be.  Any<br/>\n&gt; hint to what I&#39;m doing wrong?  Thanks for any advice you can give me<br/>\n&gt; on this.<br/>\n&gt; <br/>\n&gt; Here&#39;s the relevant code from the JUnit &#39;setUp()&#39; method:<br/>\n&gt; \t<br/>\n&gt; //////// start code\t<br/>\n&gt; try {<br/>\n<br/>\n&gt;     // since the Controller is a singleton, and may have been loaded<br/>\n&gt;     // before with different set-up data, use a ClassLoader to<br/>\n&gt;     // create a new instance of it.  This requires using Java<br/>\n&gt;     // Reflection to instantiate the object.  If we just called<br/>\n&gt;     // &quot;classForName()&quot;, the system class loader would be asked to<br/>\n&gt;     // return any previously loaded instance of the class.  Since<br/>\n&gt;     // this is what we want to avoid, a special ClassLoader returns<br/>\n&gt;     // a new instance of the class.<br/>\n&gt;     SpecialClassLoader loader = new SpecialClassLoader();<br/>\n&gt;     Class ctlrClass = loader.findClass(\t\t\t<br/>\n&gt; &quot;rdyne_rdcs.comm_gateway.controller.DefaultGatewayController&quot;);<br/>\n&gt; \t\t\t\t\t\t\t\t<br/>\n&gt;     // instantiate the controller using reflection<br/>\n&gt;     Class[] paramTypes = { Reader.class };<br/>\n&gt;     Object[] args = {reader};    // contains the &quot;test data&quot;<br/>\n&gt; \t\t\t<br/>\n&gt;     Constructor constructor = <br/>\n&gt; ctlrClass.getDeclaredConstructor(paramTypes);<br/>\n&gt;     constructor.setAccessible(true);<br/>\n&gt;     Object o = constructor.newInstance(args);<br/>\n<br/>\n </span></blockquote>If you are going to use reflection to defeat the private constructor, why bother reloading the class.<br/>\n<br/>\n<blockquote><span title=\"ireply\"> &gt; \t\t\t<br/>\n&gt;     //Method m = ctlrClass.getMethod(&quot;getController&quot;,paramTypes);<br/>\n&gt;     //m.setAccessible(true);<br/>\n&gt;     //Object o = m.invoke(null,args);<br/>\n&gt; \t\t\t<br/>\n&gt; // TODO  - Figure this out!!!!!!!!!!!!!!!!!!<br/>\n&gt; // unfortunately somehow the Object may not be cast to the required<br/>\n&gt; // class &quot;DefaultGatewayController&quot;, or even to its interface.<br/>\n&gt; // This is true whether the &quot;Constructor&quot; method or the &quot;Method&quot;<br/>\n&gt; // method is used.  <br/>\n&gt; <br/>\n&gt;     if ( DefaultGatewayController.class.isInstance(o) ) {<br/>\n&gt;         // &quot;o&quot; may safely be cast as a &quot;DefaultGatewayController&quot;<br/>\n&gt; \tSystem.out.println(&quot;YOWSA&quot;);<br/>\n&gt; \tctlr = (DefaultGatewayController)o;<br/>\n<br/>\n </span></blockquote>The problem is that &quot;DefaultGatewayController.class&quot; is not the same instance as ctlrClass. Although if DefaultGatewayController had an interface I would expect you to be able to cast it to that.<br/>\n<br/>\n<blockquote><span title=\"ireply\"> &gt;     } else {<br/>\n&gt; \tSystem.out.println(&quot;OHNO&quot;);<br/>\n&gt; \tSystem.out.println(&quot;Class: &quot; + o.getClass().getName());<br/>\n&gt;     }<br/>\n&gt; <br/>\n<br/>\n </span></blockquote>snipped exception handling - why not just declare the test as throws Exception.<br/>\n<br/>\n<blockquote><span title=\"ireply\"> &gt; This always goes thru the &quot;OHNO&quot; branch, although the output of the<br/>\n&gt; class name is what it should be to allow me to cast it.  I&#39;m fairly<br/>\n&gt; new to JUnit, and I&#39;m really new to custom Class Loaders, but it seems<br/>\n&gt; to me that this should work easily and well.  Thanks,<br/>\n&gt; - Ray Clough<br/>\n&gt; <a rel=\"nofollow\" target=\"_blank\" href=\"mailto:ray@...\">ray@...</a><br/>\n&gt; <br/>\n<br/>\n </span></blockquote>There are 2 solutions:<br/>\n1) load the entire junit test using your special classloader. This is not easy.<br/>\n<br/>\n2) Invoke the methods on ctlr using reflection.<br/>\n<br/>\nIn the files section I submitted an example of a classreloader. JB Rainsberger&#39;s JUnit Recipes also contains a recipe on this subject.<br/>\n<br/>\nI have since come up with a much simpler version of the reloader that you can find in my JIsolate project:<br/>\n<a rel=\"nofollow\" target=\"_blank\" href=\"http://sourceforge.net/projects/jisolate\">http://sourceforge.net/projects/jisolate</a><br/>\n<br/>\nNo release avaliable yet but if you pull the project from cvs into eclipse you may get some ideas.<br/>\n<br/>\n- Neil</div>", 
    "prevInTime": 14048, 
    "specialLinks": [], 
    "contentTrasformed": false, 
    "postDate": "1119944152", 
    "canDelete": false, 
    "nextInTopic": 0, 
    "prevInTopic": 0, 
    "headers": {
        "messageIdInHeader": "PEUxRG5BZFUtMDAwN2ZILTAwQHNlcnYwMS5uZWlsLnN3aW5nbGVyLm5hbWU+"
    }
}